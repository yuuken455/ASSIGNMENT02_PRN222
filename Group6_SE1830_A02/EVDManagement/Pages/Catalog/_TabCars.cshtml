@model EVDManagement.Pages.Catalog.IndexModel
@{
    const long MAX_VND = 9_999_000_000_000;
}
<div class="row g-3">
    <!-- FORM -->
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>Create Car</span>
                <button type="button" class="btn btn-sm btn-light"
                        onclick="document.querySelector('form[data-create]').scrollIntoView({behavior:'smooth'});">
                    Focus
                </button>
            </div>
            <div class="card-body">
                <div asp-validation-summary="All" class="text-danger mb-2"></div>

                <form method="post" asp-page-handler="SaveCar" data-create>
                    <label class="form-label">Model</label>
                    <input class="form-control mb-2" asp-for="CarInput.ModelName" placeholder="Model name" />
                    <span class="text-danger" asp-validation-for="CarInput.ModelName"></span>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.ModelSegment" placeholder="Model segment " />
                        </div>
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.ModelDescription" placeholder="Model description " />
                        </div>
                    </div>

                    <label class="form-label">Version</label>
                    <input class="form-control mb-2" asp-for="CarInput.VersionName" placeholder="Version name" />
                    <span class="text-danger" asp-validation-for="CarInput.VersionName"></span>

                    <div class="row g-2">
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.BatteryCapacity" placeholder="Battery (kWh)" type="number" step="0.1" />
                            <span class="text-danger" asp-validation-for="CarInput.BatteryCapacity"></span>
                        </div>
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.RangeKm" placeholder="Range (km)" type="number" />
                            <span class="text-danger" asp-validation-for="CarInput.RangeKm"></span>
                        </div>
                    </div>
                    <div class="row g-2 mt-1">
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.Seat" placeholder="Seat" type="number" />
                            <span class="text-danger" asp-validation-for="CarInput.Seat"></span>
                        </div>
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.BasePrice" placeholder="Base price" type="number" step="1000" min="0" max="@MAX_VND" id="base" />
                            <span class="text-danger" asp-validation-for="CarInput.BasePrice"></span>
                        </div>
                    </div>

                    <label class="form-label mt-2">Color</label>
                    <input class="form-control mb-2" asp-for="CarInput.ColorName" placeholder="Color name" />
                    <span class="text-danger" asp-validation-for="CarInput.ColorName"></span>

                    <div class="row g-2 mt-1">
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.ExtraCost" placeholder="Extra cost" type="number" step="1000" min="0" max="@MAX_VND" id="extra" />
                            <span class="text-danger" asp-validation-for="CarInput.ExtraCost"></span>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Final Price (Base + Extra)</label>
                            <input class="form-control" id="final" type="number" readonly />
                        </div>
                    </div>

                    <div class="row g-2 mt-1">
                        <div class="col-6">
                            <input class="form-control" asp-for="CarInput.Quantity" placeholder="Quantity" type="number" min="0" />
                            <span class="text-danger" asp-validation-for="CarInput.Quantity"></span>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-primary" type="submit" onclick="calcFinal()">Save</button>
                        <button type="reset" class="btn btn-secondary" onclick="setTimeout(()=>{calcFinal();},0)">Reset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- LIST -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>All Cars</span>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Version</th>
                            <th>Base</th>
                            <th>Color</th>
                            <th>Extra</th>
                            <th>Final</th>
                            <th>Quantity</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model.Colors)
                        {
                            var v = Model.Versions.FirstOrDefault(x => x.VersionId == c.VersionId);
                            var m = Model.Models.FirstOrDefault(x => x.ModelId == v?.ModelId);

                            var basePrice = v?.BasePrice ?? 0;
                            var extra = c.ExtraCost ?? 0;
                            var final = basePrice + extra;

                            int qty = 0;
                            Model.InventoryMap.TryGetValue((v?.VersionId ?? 0, c.ColorId), out qty);

                            <tr>
                                <td>
                                    <div class="fw-semibold">@m?.ModelName</div>
                                    <div class="text-muted small">@m?.Segment</div>
                                </td>
                                <td>
                                    <div>@v?.VersionName</div>
                                    <div class="text-muted small">@v?.BatteryCapacity kWh · @v?.RangeKm km · @v?.Seat seat</div>
                                </td>
                                <td>@basePrice.ToString("N0")</td>
                                <td>@c.ColorName</td>
                                <td>@extra.ToString("N0")</td>
                                <td class="fw-semibold">@final.ToString("N0")</td>
                                <td>@qty</td>
                                <td class="text-end">
                                    <!-- EDIT -->
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary me-2"
                                            data-bs-toggle="modal"
                                            data-bs-target="#carEditModal"
                                            data-model-id="@(m?.ModelId ?? 0)"
                                            data-version-id="@(v?.VersionId ?? 0)"
                                            data-color-id="@c.ColorId"  
                                            data-model-name="@m?.ModelName"
                                            data-model-seg="@m?.Segment"
                                            data-model-desc="@m?.Description"
                                            data-version-name="@v?.VersionName"
                                            data-batt="@((v?.BatteryCapacity)?.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture))"
                                            data-range="@v?.RangeKm"
                                            data-seat="@v?.Seat"
                                            data-base="@((v?.BasePrice)?.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture))"
                                            data-color-name="@c.ColorName"
                                            data-extra="@((c?.ExtraCost)?.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture))"
                                            data-qty="@qty">
                                        Edit
                                    </button>

                                    <!-- DELETE -->
                                    <form method="post" asp-page-handler="DeleteCar" class="d-inline"
                                          onsubmit="return confirm('Delete this car?');">
                                        <input type="hidden" name="colorId" value="@c.ColorId" />
                                        <button class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
